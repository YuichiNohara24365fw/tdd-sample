name: Claude Code Actions

on:
  issue_comment:
    types: [created]
  pull_request_comment:
    types: [created]
  issues:
    types: [opened, assigned]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  claude-response:
    runs-on: ubuntu-latest
    name: "Claude AI Assistant"
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'issues' && contains(github.event.issue.title, '[CLAUDE]'))
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # フルヒストリーを取得（コード分析のため）
        fetch-depth: 0
        
    - name: Claude Code Assistant
      uses: anthropics/claude-code-action@beta
      with:
        # 認証設定（Maxプラン OAuth方式）
        claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        github_token: ${{ secrets.GITHUB_TOKEN }}
        
        # Claude 4 モデル設定（2025年5月リリース）
        model: "claude-opus-4-20250514"
        fallback_model: "claude-sonnet-4-20250514"
        
        # トリガー設定
        trigger_phrase: "@claude"
        
        # タイムアウト設定（長時間処理対応 - 実験的最大値）
        timeout_minutes: 180
        
        # プロジェクト固有の設定はCLAUDE.mdファイルで定義