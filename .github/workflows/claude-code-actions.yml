name: Claude Code Actions Advanced

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created, edited]

jobs:
  claude-code-actions:
    name: "ğŸ¤– Claude Code Actions"
    runs-on: ubuntu-latest
    if: contains(github.event.issue.title, '[CLAUDE]') || contains(github.event.issue.labels.*.name, 'claude-actions') || contains(github.event.comment.body, '@claude')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Parse Claude instructions
      id: parse
      run: |
        echo "Parsing Claude instructions..."
        
        # Get issue body or comment body
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          INSTRUCTION_TEXT="${{ github.event.comment.body }}"
        else
          INSTRUCTION_TEXT="${{ github.event.issue.body }}"
        fi
        
        echo "Raw instruction: $INSTRUCTION_TEXT"
        
        # Determine action type based on keywords
        if echo "$INSTRUCTION_TEXT" | grep -qi "æ–°ã—ã„ã‚¯ãƒ©ã‚¹\|new class\|ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆ\|create class"; then
          echo "action_type=create_class" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "æ–°ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰\|new method\|ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ \|add method"; then
          echo "action_type=add_method" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ \|add test\|ãƒ†ã‚¹ãƒˆä½œæˆ\|create test"; then
          echo "action_type=add_test" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "ãƒªãƒ•ã‚¡ã‚¯ã‚¿\|refactor\|æ”¹å–„\|improve"; then
          echo "action_type=refactor" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "ãƒ¬ãƒ“ãƒ¥ãƒ¼\|review\|ãƒã‚§ãƒƒã‚¯\|check\|åˆ†æ\|analyze"; then
          echo "action_type=code_review" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "ãƒã‚°ä¿®æ­£\|bug fix\|fix bug\|ä¿®æ­£"; then
          echo "action_type=bug_fix" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "TDD\|red.*green.*refactor"; then
          echo "action_type=tdd_cycle" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "å…¨ãƒ†ã‚¹ãƒˆ\|all test\|test.*all"; then
          echo "action_type=run_all_tests" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "ã‚«ãƒãƒ¬ãƒƒã‚¸\|coverage"; then
          echo "action_type=check_coverage" >> $GITHUB_OUTPUT
        else
          echo "action_type=general" >> $GITHUB_OUTPUT
        fi
        
        # Extract class name if mentioned
        CLASS_NAME=$(echo "$INSTRUCTION_TEXT" | grep -oiE "(Calculator|StringUtils|ArrayUtils|[A-Z][a-zA-Z]*Utils?)" | head -1)
        echo "target_class=${CLASS_NAME:-Unknown}" >> $GITHUB_OUTPUT
        
        # Extract method name if mentioned
        METHOD_NAME=$(echo "$INSTRUCTION_TEXT" | grep -oiE "(sqrt|factorial|power|unique|sum|average|[a-z][a-zA-Z]*)" | head -1)
        echo "target_method=${METHOD_NAME:-unknown}" >> $GITHUB_OUTPUT

    - name: Execute Claude action
      id: execute
      run: |
        ACTION_TYPE="${{ steps.parse.outputs.action_type }}"
        TARGET_CLASS="${{ steps.parse.outputs.target_class }}"
        TARGET_METHOD="${{ steps.parse.outputs.target_method }}"
        
        echo "Executing action: $ACTION_TYPE"
        echo "Target class: $TARGET_CLASS"
        echo "Target method: $TARGET_METHOD"
        
        case $ACTION_TYPE in
          "create_class")
            echo "ğŸ—ï¸ Creating new class: $TARGET_CLASS"
            if [ "$TARGET_CLASS" = "ArrayUtils" ]; then
              cat > "src/${TARGET_CLASS,,}.js" << 'EOF'
export class ArrayUtils {
  static unique(array) {
    return [...new Set(array)];
  }
  
  static sum(array) {
    return array.reduce((acc, val) => acc + val, 0);
  }
  
  static average(array) {
    if (array.length === 0) throw new Error('Array cannot be empty');
    return this.sum(array) / array.length;
  }
  
  static max(array) {
    if (array.length === 0) throw new Error('Array cannot be empty');
    return Math.max(...array);
  }
  
  static min(array) {
    if (array.length === 0) throw new Error('Array cannot be empty');
    return Math.min(...array);
  }
}
EOF
              echo "âœ… Created ArrayUtils class"
            else
              echo "âš ï¸ Unknown class: $TARGET_CLASS"
            fi
            ;;
            
          "add_method")
            echo "ğŸ”§ Adding method: $TARGET_METHOD to $TARGET_CLASS"
            if [ "$TARGET_CLASS" = "Calculator" ] && [ "$TARGET_METHOD" = "sqrt" ]; then
              # Add sqrt method to Calculator
              sed -i '/power(base, exponent) {/a\\n  sqrt(n) {\n    if (n < 0) {\n      throw new Error('\''Square root of negative number is not allowed'\'');\n    }\n    return Math.sqrt(n);\n  }' src/calculator.js || echo "Method may already exist"
              echo "âœ… Added sqrt method to Calculator"
            elif [ "$TARGET_CLASS" = "Calculator" ] && [ "$TARGET_METHOD" = "factorial" ]; then
              sed -i '/power(base, exponent) {/a\\n  factorial(n) {\n    if (n < 0) {\n      throw new Error('\''Factorial of negative number is not allowed'\'');\n    }\n    if (n === 0 || n === 1) return 1;\n    let result = 1;\n    for (let i = 2; i <= n; i++) {\n      result *= i;\n    }\n    return result;\n  }' src/calculator.js || echo "Method may already exist"
              echo "âœ… Added factorial method to Calculator"
            else
              echo "âš ï¸ Unknown method/class combination"
            fi
            ;;
            
          "add_test")
            echo "ğŸ§ª Adding tests for: $TARGET_CLASS.$TARGET_METHOD"
            if [ "$TARGET_CLASS" = "Calculator" ] && [ "$TARGET_METHOD" = "sqrt" ]; then
              cat >> "tests/calculator.test.js" << 'EOF'

  describe('sqrt', () => {
    test('should calculate square root of positive numbers', () => {
      expect(calculator.sqrt(4)).toBe(2);
      expect(calculator.sqrt(9)).toBe(3);
      expect(calculator.sqrt(16)).toBe(4);
    });

    test('should handle square root of zero', () => {
      expect(calculator.sqrt(0)).toBe(0);
    });

    test('should throw error for negative numbers', () => {
      expect(() => calculator.sqrt(-4)).toThrow('Square root of negative number is not allowed');
    });
  });
EOF
              echo "âœ… Added sqrt tests to Calculator"
            else
              echo "âš ï¸ Test template not available for $TARGET_CLASS.$TARGET_METHOD"
            fi
            ;;
            
          "run_all_tests")
            echo "ğŸ§ª Running all tests..."
            npm test > test_results.txt 2>&1
            ;;
            
          "check_coverage")
            echo "ğŸ“Š Checking test coverage..."
            npm run test:coverage > coverage_results.txt 2>&1
            ;;
            
          "tdd_cycle")
            echo "ğŸ”„ Running TDD cycle..."
            npm run tdd:cycle > tdd_results.txt 2>&1 || true
            ;;
            
          "refactor")
            echo "ğŸ”§ Running refactor checks..."
            npm run lint > lint_results.txt 2>&1 || true
            npm test > refactor_test_results.txt 2>&1
            ;;
            
          "code_review")
            echo "ğŸ‘ï¸ Running code review analysis..."
            echo "Triggering comprehensive code review..." > review_trigger.txt
            npm run lint > review_lint.txt 2>&1 || true
            npm run test:coverage > review_coverage.txt 2>&1 || true
            echo "Code review analysis completed" >> review_trigger.txt
            ;;
            
          *)
            echo "ğŸ¤– Running general tests..."
            npm test > general_results.txt 2>&1
            ;;
        esac
        
        echo "action_completed=$ACTION_TYPE" >> $GITHUB_OUTPUT

    - name: Commit changes if any
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git add -A
          git commit -m "ğŸ¤– Claude Code Actions: ${{ steps.parse.outputs.action_type }}

Auto-generated changes for Issue #${{ github.event.issue.number }}
Target: ${{ steps.parse.outputs.target_class }}.${{ steps.parse.outputs.target_method }}

ğŸ¤– Generated with Claude Code Actions Integration" || echo "Commit failed or no changes"
          git push || echo "Push failed"
        fi

    - name: Post comprehensive results
      uses: actions/github-script@v7
      env:
        ACTION_TYPE: ${{ steps.parse.outputs.action_type }}
        TARGET_CLASS: ${{ steps.parse.outputs.target_class }}
        TARGET_METHOD: ${{ steps.parse.outputs.target_method }}
      with:
        script: |
          const actionType = process.env.ACTION_TYPE;
          const targetClass = process.env.TARGET_CLASS;
          const targetMethod = process.env.TARGET_METHOD;
          const issueNumber = context.issue.number;
          const currentTime = new Date().toISOString();
          
          // Read result files
          const fs = require('fs');
          let results = '';
          let status = 'âœ… æˆåŠŸ';
          
          try {
            if (fs.existsSync('test_results.txt')) {
              results = fs.readFileSync('test_results.txt', 'utf8');
            } else if (fs.existsSync('coverage_results.txt')) {
              results = fs.readFileSync('coverage_results.txt', 'utf8');
            } else if (fs.existsSync('tdd_results.txt')) {
              results = fs.readFileSync('tdd_results.txt', 'utf8');
            } else {
              results = 'Code changes completed successfully';
            }
            
            if (results.includes('FAIL') || results.includes('error')) {
              status = 'âŒ ã‚¨ãƒ©ãƒ¼ã‚ã‚Š';
            }
          } catch (e) {
            results = 'Results file not found - action may have completed successfully';
          }
          
          const actionDescriptions = {
            'create_class': 'ğŸ—ï¸ æ–°ã—ã„ã‚¯ãƒ©ã‚¹ä½œæˆ',
            'add_method': 'ğŸ”§ ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ ',
            'add_test': 'ğŸ§ª ãƒ†ã‚¹ãƒˆè¿½åŠ ',
            'refactor': 'ğŸ”§ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°',
            'bug_fix': 'ğŸ› ãƒã‚°ä¿®æ­£',
            'tdd_cycle': 'ğŸ”„ TDDã‚µã‚¤ã‚¯ãƒ«å®Ÿè¡Œ',
            'run_all_tests': 'ğŸ§ª å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ',
            'check_coverage': 'ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª',
            'general': 'ğŸ¤– ä¸€èˆ¬çš„ãªå‡¦ç†'
          };
          
          const comment = [
            '## ğŸ¤– Claude Code Actions - å®Ÿè¡Œçµæœ',
            '',
            `**Issue**: #${issueNumber}`,
            `**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ${actionDescriptions[actionType] || actionType}`,
            `**å¯¾è±¡**: ${targetClass}.${targetMethod}`,
            `**å®Ÿè¡Œæ™‚åˆ»**: ${currentTime}`,
            '',
            '### ğŸ“‹ å®Ÿè¡Œçµæœ',
            '```',
            results,
            '```',
            '',
            '### ğŸ¯ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
            status,
            '',
            '### ğŸ’¡ æ¬¡ã«å®Ÿè¡Œå¯èƒ½ãªæŒ‡ç¤ºä¾‹',
            '- `æ–°ã—ã„ã‚¯ãƒ©ã‚¹ "ArrayUtils" ã‚’ä½œæˆã—ã¦ãã ã•ã„`',
            '- `Calculatorã‚¯ãƒ©ã‚¹ã« "sqrt" ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã—ã¦ãã ã•ã„`',
            '- `sqrt ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„`',
            '- `å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„`',
            '- `ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’ç¢ºèªã—ã¦ãã ã•ã„`',
            '- `TDDã‚µã‚¤ã‚¯ãƒ«ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„`',
            '',
            '---',
            '*ğŸ¤– Claude Code Actions ã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ*'
          ].join('\n');

          await github.rest.issues.createComment({
            issue_number: issueNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Add action label
      uses: actions/github-script@v7
      with:
        script: |
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['claude-actions-executed', '${{ steps.parse.outputs.action_type }}']
          });