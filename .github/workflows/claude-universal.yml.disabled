name: Claude Universal Actions

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created, edited]
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-universal:
    name: "ğŸ¤– Claude Universal Actions"
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.title, '[CLAUDE]') || 
      contains(github.event.issue.title, '[REVIEW]') ||
      contains(github.event.issue.title, '[REFACTOR]') ||
      contains(github.event.issue.labels.*.name, 'claude-actions') ||
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.pull_request.title, '[CLAUDE]')
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Parse instructions
      id: parse
      run: |
        echo "Parsing Claude instructions..."
        
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          INSTRUCTION_TEXT="${{ github.event.pull_request.title }} ${{ github.event.pull_request.body }}"
          CONTEXT_TYPE="pull_request"
          CONTEXT_NUMBER="${{ github.event.pull_request.number }}"
        elif [ "${{ github.event_name }}" = "issue_comment" ]; then
          INSTRUCTION_TEXT="${{ github.event.comment.body }}"
          CONTEXT_TYPE="issue"
          CONTEXT_NUMBER="${{ github.event.issue.number }}"
        else
          INSTRUCTION_TEXT="${{ github.event.issue.title }} ${{ github.event.issue.body }}"
          CONTEXT_TYPE="issue"
          CONTEXT_NUMBER="${{ github.event.issue.number }}"
        fi
        
        echo "context_type=$CONTEXT_TYPE" >> $GITHUB_OUTPUT
        echo "context_number=$CONTEXT_NUMBER" >> $GITHUB_OUTPUT
        
        # Determine action type
        if echo "$INSTRUCTION_TEXT" | grep -qi "review\|ãƒ¬ãƒ“ãƒ¥ãƒ¼\|ãƒã‚§ãƒƒã‚¯\|åˆ†æ"; then
          echo "action_type=review" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "refactor\|ãƒªãƒ•ã‚¡ã‚¯ã‚¿\|æ”¹å–„\|æœ€é©åŒ–"; then
          echo "action_type=refactor" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "æ–°ã—ã„.*ã‚¯ãƒ©ã‚¹\|new.*class\|ãƒ¡ã‚½ãƒƒãƒ‰.*è¿½åŠ \|add.*method"; then
          echo "action_type=generate" >> $GITHUB_OUTPUT
        elif echo "$INSTRUCTION_TEXT" | grep -qi "ãƒ†ã‚¹ãƒˆ\|test\|TDD"; then
          echo "action_type=test" >> $GITHUB_OUTPUT
        else
          echo "action_type=general" >> $GITHUB_OUTPUT
        fi

    - name: Execute action
      id: execute
      run: |
        ACTION_TYPE="${{ steps.parse.outputs.action_type }}"
        echo "Executing action: $ACTION_TYPE"
        
        echo "=== CLAUDE UNIVERSAL ACTIONS REPORT ===" > report.txt
        echo "Action: $ACTION_TYPE" >> report.txt
        echo "Time: $(date)" >> report.txt
        echo "" >> report.txt
        
        case $ACTION_TYPE in
          "review")
            echo "ğŸ‘ï¸ Executing code review..."
            echo "=== CODE REVIEW ===" >> report.txt
            npm run lint >> report.txt 2>&1 || echo "Lint completed" >> report.txt
            echo "" >> report.txt
            npm run test:coverage >> report.txt 2>&1 || echo "Coverage completed" >> report.txt
            ;;
          "refactor")
            echo "ğŸ”§ Executing refactoring..."
            echo "=== REFACTORING ===" >> report.txt
            find src -name "*.js" -exec sed -i.bak '/console\.log/d' {} \; 2>/dev/null || echo "Cleanup attempted"
            npm test >> report.txt 2>&1 || echo "Tests completed" >> report.txt
            ;;
          "generate")
            echo "ğŸ—ï¸ Executing code generation..."
            echo "=== CODE GENERATION ===" >> report.txt
            if [ ! -f "src/arrayutils.js" ]; then
              echo "export class ArrayUtils {" > "src/arrayutils.js"
              echo "  static unique(array) {" >> "src/arrayutils.js"
              echo "    return [...new Set(array)];" >> "src/arrayutils.js"
              echo "  }" >> "src/arrayutils.js"
              echo "  static sum(array) {" >> "src/arrayutils.js"
              echo "    return array.reduce((acc, val) => acc + val, 0);" >> "src/arrayutils.js"
              echo "  }" >> "src/arrayutils.js"
              echo "}" >> "src/arrayutils.js"
              echo "Generated ArrayUtils class" >> report.txt
            fi
            ;;
          "test")
            echo "ğŸ§ª Executing testing..."
            echo "=== TESTING ===" >> report.txt
            npm test >> report.txt 2>&1 || echo "Tests completed" >> report.txt
            ;;
          *)
            echo "ğŸ¤– Executing general analysis..."
            echo "=== GENERAL ANALYSIS ===" >> report.txt
            npm test >> report.txt 2>&1 || echo "Analysis completed" >> report.txt
            ;;
        esac

    - name: Commit changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if ! git diff --quiet || ! git diff --staged --quiet; then
          git add -A
          COMMIT_MSG="ğŸ¤– Claude Universal: ${{ steps.parse.outputs.action_type }}
        
        Auto-generated for ${{ steps.parse.outputs.context_type }} #${{ steps.parse.outputs.context_number }}
        
        ğŸ¤– Generated with Claude Universal Actions"
          git commit -m "$COMMIT_MSG" || echo "Commit failed"
          git push || echo "Push failed"
        fi

    - name: Post results
      uses: actions/github-script@v7
      env:
        ACTION_TYPE: ${{ steps.parse.outputs.action_type }}
        CONTEXT_TYPE: ${{ steps.parse.outputs.context_type }}
        CONTEXT_NUMBER: ${{ steps.parse.outputs.context_number }}
      with:
        script: |
          const fs = require('fs');
          const actionType = process.env.ACTION_TYPE;
          const contextType = process.env.CONTEXT_TYPE;
          const contextNumber = process.env.CONTEXT_NUMBER;
          const currentTime = new Date().toISOString();
          
          let report = '';
          try {
            report = fs.readFileSync('report.txt', 'utf8');
          } catch (e) {
            report = 'Report not available';
          }
          
          const actionDescriptions = {
            'review': 'ğŸ‘ï¸ ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼',
            'refactor': 'ğŸ”§ ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°',
            'generate': 'ğŸ—ï¸ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ',
            'test': 'ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ',
            'general': 'ğŸ¤– ä¸€èˆ¬åˆ†æ'
          };
          
          const status = report.includes('Error') || report.includes('FAIL') ? 'âŒ ã‚¨ãƒ©ãƒ¼' : 'âœ… æˆåŠŸ';
          
          const comment = [
            '## ğŸ¤– Claude Universal Actions - å®Ÿè¡Œå®Œäº†',
            '',
            `**${contextType.charAt(0).toUpperCase() + contextType.slice(1)}**: #${contextNumber}`,
            `**ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ${actionDescriptions[actionType] || actionType}`,
            `**å®Ÿè¡Œæ™‚åˆ»**: ${currentTime}`,
            `**çµæœ**: ${status}`,
            '',
            '### ğŸ“‹ å®Ÿè¡Œãƒ¬ãƒãƒ¼ãƒˆ',
            '```',
            report,
            '```',
            '',
            '### ğŸ’¡ æ¬¡å›å®Ÿè¡Œä¾‹',
            '- `[CLAUDE] ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„`',
            '- `[CLAUDE] ArrayUtils ã‚¯ãƒ©ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„`',
            '- `[REFACTOR] é‡è¤‡ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„`',
            '- `[CLAUDE] å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„`',
            '',
            '---',
            '*ğŸ¤– Claude Universal Actions ã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œ*'
          ].join('\n');

          const targetNumber = parseInt(contextNumber);
          
          await github.rest.issues.createComment({
            issue_number: targetNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Add labels
      uses: actions/github-script@v7
      with:
        script: |
          const actionType = '${{ steps.parse.outputs.action_type }}';
          const contextNumber = parseInt('${{ steps.parse.outputs.context_number }}');
          
          await github.rest.issues.addLabels({
            issue_number: contextNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: ['claude-universal', actionType]
          });