name: Claude Refactoring

on:
  issues:
    types: [opened, edited, labeled]
  issue_comment:
    types: [created, edited]

jobs:
  claude-refactoring:
    name: "ğŸ”§ Claude Refactoring"
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.title, '[REFACTOR]') || 
      contains(github.event.issue.labels.*.name, 'refactoring') ||
      contains(github.event.comment.body, '@claude-refactor') ||
      (contains(github.event.issue.body, 'ãƒªãƒ•ã‚¡ã‚¯ã‚¿') || contains(github.event.issue.body, 'refactor'))
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm install

    - name: Backup original code
      run: |
        echo "ğŸ“ Creating backup of original code..."
        mkdir -p backups
        cp -r src/ backups/src_backup_$(date +%Y%m%d_%H%M%S)/
        echo "Backup created in backups/ directory"

    - name: Analyze refactoring requirements
      id: analyze
      run: |
        echo "ğŸ” Analyzing refactoring requirements..."
        
        # Get refactoring instructions
        if [ "${{ github.event_name }}" = "issue_comment" ]; then
          REFACTOR_TEXT="${{ github.event.comment.body }}"
        else
          REFACTOR_TEXT="${{ github.event.issue.body }}"
        fi
        
        echo "Refactor instruction: $REFACTOR_TEXT"
        
        # Determine refactoring type
        if echo "$REFACTOR_TEXT" | grep -qi "é‡è¤‡.*å‰Šé™¤\|duplicate.*remove\|DRY"; then
          echo "refactor_type=remove_duplication" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "é–¢æ•°.*åˆ†å‰²\|function.*split\|extract.*method"; then
          echo "refactor_type=extract_method" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "å¤‰æ•°å.*å¤‰æ›´\|rename.*variable\|å‘½å"; then
          echo "refactor_type=rename_variables" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "ã‚³ãƒ¡ãƒ³ãƒˆ.*è¿½åŠ \|add.*comment\|documentation"; then
          echo "refactor_type=add_documentation" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "å‹.*å®‰å…¨\|type.*safety\|typescript"; then
          echo "refactor_type=improve_typing" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "ã‚¨ãƒ©ãƒ¼.*å‡¦ç†\|error.*handling"; then
          echo "refactor_type=improve_error_handling" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹\|performance\|æœ€é©åŒ–\|optimize"; then
          echo "refactor_type=optimize_performance" >> $GITHUB_OUTPUT
        elif echo "$REFACTOR_TEXT" | grep -qi "å¯èª­æ€§\|readability\|clean.*code"; then
          echo "refactor_type=improve_readability" >> $GITHUB_OUTPUT
        else
          echo "refactor_type=general_cleanup" >> $GITHUB_OUTPUT
        fi
        
        # Extract target files
        TARGET_FILES=$(echo "$REFACTOR_TEXT" | grep -oE "(src/[a-zA-Z0-9_.-]+\.(js|ts|jsx|tsx))" | head -3)
        if [ -z "$TARGET_FILES" ]; then
          TARGET_FILES="src/calculator.js src/stringUtils.js"
        fi
        echo "target_files=$TARGET_FILES" >> $GITHUB_OUTPUT

    - name: Run pre-refactoring tests
      id: pre_tests
      run: |
        echo "ğŸ§ª Running pre-refactoring tests..."
        npm test > pre_refactor_tests.txt 2>&1
        if [ $? -eq 0 ]; then
          echo "pre_tests_status=passed" >> $GITHUB_OUTPUT
          echo "âœ… All tests passed before refactoring"
        else
          echo "pre_tests_status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Some tests failed before refactoring"
        fi

    - name: Execute refactoring
      id: refactor
      run: |
        REFACTOR_TYPE="${{ steps.analyze.outputs.refactor_type }}"
        TARGET_FILES="${{ steps.analyze.outputs.target_files }}"
        
        echo "ğŸ”§ Executing refactoring: $REFACTOR_TYPE"
        echo "Target files: $TARGET_FILES"
        
        case $REFACTOR_TYPE in
          "remove_duplication")
            echo "ğŸ”„ Removing code duplication..."
            
            # Example: Extract common validation logic
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for duplication removal..."
                
                # Add common validation utility if not exists
                if ! grep -q "validateInput" "$file"; then
                  # Add validation helper at the end of class
                  sed -i '/^}$/i\
\
  static validateInput(value, type = "number") {\
    if (value === null || value === undefined) {\
      throw new Error(`Input cannot be null or undefined`);\
    }\
    if (type === "number" && (typeof value !== "number" || isNaN(value))) {\
      throw new Error(`Expected a valid number, got ${typeof value}`);\
    }\
    return true;\
  }' "$file" 2>/dev/null || echo "Validation method may already exist"
                fi
                
                echo "âœ… Processed $file for duplication removal"
              fi
            done
            ;;
            
          "extract_method")
            echo "ğŸ“¦ Extracting methods for better modularity..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for method extraction..."
                
                # Example: Extract complex calculations
                if grep -q "Math.pow\|Math.sqrt" "$file"; then
                  # Add utility methods
                  sed -i '/^}$/i\
\
  static isValidNumber(n) {\
    return typeof n === "number" && !isNaN(n) && isFinite(n);\
  }\
\
  static formatResult(result, precision = 10) {\
    return Math.round(result * Math.pow(10, precision)) / Math.pow(10, precision);\
  }' "$file" 2>/dev/null || echo "Utility methods may already exist"
                fi
                
                echo "âœ… Extracted utility methods in $file"
              fi
            done
            ;;
            
          "rename_variables")
            echo "ğŸ“ Improving variable naming..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for variable renaming..."
                
                # Improve variable names (basic examples)
                sed -i 's/\<n\>/number/g; s/\<str\>/text/g; s/\<arr\>/array/g' "$file" 2>/dev/null || echo "Variables may already have good names"
                
                echo "âœ… Improved variable names in $file"
              fi
            done
            ;;
            
          "add_documentation")
            echo "ğŸ“š Adding comprehensive documentation..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for documentation..."
                
                # Add JSDoc comments to class
                if grep -q "export class" "$file" && ! grep -q "/\*\*" "$file"; then
                  CLASS_NAME=$(grep -o "export class [A-Za-z]*" "$file" | cut -d' ' -f3)
                  sed -i "/export class $CLASS_NAME/i\\
/**\\
 * $CLASS_NAME - Utility class for mathematical operations\\
 * Provides safe and reliable mathematical functions with proper error handling\\
 */\\
" "$file" 2>/dev/null
                fi
                
                # Add method documentation
                sed -i '/add(a, b)/i\
  /**\
   * Adds two numbers together\
   * @param {number} a - First number\
   * @param {number} b - Second number\
   * @returns {number} Sum of a and b\
   */\
' "$file" 2>/dev/null || echo "Documentation may already exist"
                
                echo "âœ… Added documentation to $file"
              fi
            done
            ;;
            
          "improve_error_handling")
            echo "ğŸ›¡ï¸ Improving error handling..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for error handling..."
                
                # Add input validation to methods
                if grep -q "divide.*{" "$file"; then
                  sed -i '/divide.*{/a\
    if (typeof a !== "number" || typeof b !== "number") {\
      throw new TypeError("Both arguments must be numbers");\
    }\
    if (!isFinite(a) || !isFinite(b)) {\
      throw new RangeError("Arguments must be finite numbers");\
    }' "$file" 2>/dev/null || echo "Error handling may already exist"
                fi
                
                echo "âœ… Improved error handling in $file"
              fi
            done
            ;;
            
          "optimize_performance")
            echo "âš¡ Optimizing performance..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for performance optimization..."
                
                # Add memoization for expensive operations
                sed -i '/^export class/a\
  constructor() {\
    this._cache = new Map();\
  }\
\
  _getCacheKey(...args) {\
    return JSON.stringify(args);\
  }' "$file" 2>/dev/null || echo "Performance optimizations may already exist"
                
                echo "âœ… Added performance optimizations to $file"
              fi
            done
            ;;
            
          "improve_readability")
            echo "ğŸ“– Improving code readability..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for readability improvements..."
                
                # Add constants for magic numbers
                sed -i '/^export class/a\
  static get PRECISION() { return 10; }\
  static get MAX_SAFE_INPUT() { return Number.MAX_SAFE_INTEGER; }\
  static get MIN_SAFE_INPUT() { return Number.MIN_SAFE_INTEGER; }' "$file" 2>/dev/null || echo "Constants may already exist"
                
                echo "âœ… Improved readability of $file"
              fi
            done
            ;;
            
          *)
            echo "ğŸ§¹ General code cleanup..."
            
            for file in $TARGET_FILES; do
              if [ -f "$file" ]; then
                echo "Processing $file for general cleanup..."
                
                # Remove console.log statements
                sed -i '/console\.log/d' "$file" 2>/dev/null
                
                # Add consistent spacing
                sed -i 's/){/) {/g; s/}else/} else/g' "$file" 2>/dev/null
                
                echo "âœ… General cleanup completed for $file"
              fi
            done
            ;;
        esac
        
        echo "refactor_completed=true" >> $GITHUB_OUTPUT

    - name: Run post-refactoring tests
      id: post_tests
      run: |
        echo "ğŸ§ª Running post-refactoring tests..."
        npm test > post_refactor_tests.txt 2>&1
        if [ $? -eq 0 ]; then
          echo "post_tests_status=passed" >> $GITHUB_OUTPUT
          echo "âœ… All tests passed after refactoring"
        else
          echo "post_tests_status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Some tests failed after refactoring"
        fi

    - name: Run quality checks
      id: quality
      run: |
        echo "ğŸ“Š Running quality checks..."
        
        # ESLint check
        npm run lint > refactor_lint.txt 2>&1 || echo "Lint completed with issues"
        
        # Coverage check
        npm run test:coverage > refactor_coverage.txt 2>&1 || echo "Coverage analysis completed"
        
        # Complexity analysis (basic)
        echo "=== Code Complexity Analysis ===" > complexity_analysis.txt
        for file in src/*.js; do
          if [ -f "$file" ]; then
            LINES=$(wc -l < "$file")
            FUNCTIONS=$(grep -c "function\|=>" "$file" 2>/dev/null || echo 0)
            echo "$file: $LINES lines, $FUNCTIONS functions" >> complexity_analysis.txt
          fi
        done

    - name: Generate refactoring report
      id: report
      run: |
        echo "ğŸ“‹ Generating refactoring report..."
        
        cat > refactoring_report.txt << EOF
=== CLAUDE REFACTORING REPORT ===
Refactoring Type: ${{ steps.analyze.outputs.refactor_type }}
Target Files: ${{ steps.analyze.outputs.target_files }}
Execution Time: $(date)

=== PRE-REFACTORING STATUS ===
Tests Status: ${{ steps.pre_tests.outputs.pre_tests_status }}

=== REFACTORING CHANGES ===
$(git diff --name-only 2>/dev/null || echo "No changes detected")

=== POST-REFACTORING STATUS ===
Tests Status: ${{ steps.post_tests.outputs.post_tests_status }}

=== QUALITY METRICS ===
EOF
        
        # Add lint results
        echo "ESLint Results:" >> refactoring_report.txt
        head -20 refactor_lint.txt >> refactoring_report.txt 2>/dev/null || echo "No lint issues" >> refactoring_report.txt
        
        # Add coverage info
        echo -e "\nCoverage Results:" >> refactoring_report.txt
        grep -E "All files|%" refactor_coverage.txt 2>/dev/null | head -5 >> refactoring_report.txt || echo "Coverage data not available" >> refactoring_report.txt
        
        # Add complexity analysis
        echo -e "\nComplexity Analysis:" >> refactoring_report.txt
        cat complexity_analysis.txt >> refactoring_report.txt

    - name: Commit refactored code
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git add -A
          git commit -m "ğŸ”§ Claude Refactoring: ${{ steps.analyze.outputs.refactor_type }}

Automated refactoring for Issue #${{ github.event.issue.number }}
Target files: ${{ steps.analyze.outputs.target_files }}

Changes:
- Refactoring type: ${{ steps.analyze.outputs.refactor_type }}
- Pre-refactor tests: ${{ steps.pre_tests.outputs.pre_tests_status }}
- Post-refactor tests: ${{ steps.post_tests.outputs.post_tests_status }}

ğŸ”§ Generated with Claude Refactoring System" || echo "Commit failed or no changes"
          git push || echo "Push failed"
        fi

    - name: Post refactoring results
      uses: actions/github-script@v7
      env:
        REFACTOR_TYPE: ${{ steps.analyze.outputs.refactor_type }}
        PRE_TESTS: ${{ steps.pre_tests.outputs.pre_tests_status }}
        POST_TESTS: ${{ steps.post_tests.outputs.post_tests_status }}
        TARGET_FILES: ${{ steps.analyze.outputs.target_files }}
      with:
        script: |
          const fs = require('fs');
          const refactorType = process.env.REFACTOR_TYPE;
          const preTests = process.env.PRE_TESTS;
          const postTests = process.env.POST_TESTS;
          const targetFiles = process.env.TARGET_FILES;
          const issueNumber = context.issue.number;
          const currentTime = new Date().toISOString();
          
          // Read refactoring report
          let report = '';
          try {
            report = fs.readFileSync('refactoring_report.txt', 'utf8');
          } catch (e) {
            report = 'Refactoring report not available';
          }
          
          const refactorTypeDescriptions = {
            'remove_duplication': 'ğŸ”„ é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤',
            'extract_method': 'ğŸ“¦ ãƒ¡ã‚½ãƒƒãƒ‰æŠ½å‡º',
            'rename_variables': 'ğŸ“ å¤‰æ•°åæ”¹å–„',
            'add_documentation': 'ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ ',
            'improve_error_handling': 'ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–',
            'optimize_performance': 'âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–',
            'improve_readability': 'ğŸ“– å¯èª­æ€§å‘ä¸Š',
            'general_cleanup': 'ğŸ§¹ å…¨èˆ¬çš„ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—'
          };
          
          const overallStatus = preTests === 'passed' && postTests === 'passed' ? 'âœ… æˆåŠŸ' : 
                               postTests === 'failed' ? 'âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—' : 'âš ï¸ è¦ç¢ºèª';
          
          const comment = [
            '## ğŸ”§ Claude Refactoring - å®Ÿè¡Œå®Œäº†',
            '',
            `**Issue**: #${issueNumber}`,
            `**ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç¨®åˆ¥**: ${refactorTypeDescriptions[refactorType] || refactorType}`,
            `**å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«**: ${targetFiles}`,
            `**å®Ÿè¡Œæ™‚åˆ»**: ${currentTime}`,
            `**ç·åˆçµæœ**: ${overallStatus}`,
            '',
            '### ğŸ“Š å®Ÿè¡Œçµæœã‚µãƒãƒªãƒ¼',
            `- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å‰ãƒ†ã‚¹ãƒˆ**: ${preTests === 'passed' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`,
            `- **ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°å¾Œãƒ†ã‚¹ãƒˆ**: ${postTests === 'passed' ? 'âœ… é€šé' : 'âŒ å¤±æ•—'}`,
            `- **ã‚³ãƒ¼ãƒ‰å¤‰æ›´**: ${overallStatus.includes('æˆåŠŸ') ? 'âœ… é©ç”¨æ¸ˆã¿' : 'âš ï¸ è¦ç¢ºèª'}`,
            '',
            '### ğŸ“‹ è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ',
            '```',
            report,
            '```',
            '',
            '### ğŸ¯ æ¬¡å›ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æŒ‡ç¤ºä¾‹',
            '- `[REFACTOR] é‡è¤‡ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„`',
            '- `[REFACTOR] Calculator ã‚¯ãƒ©ã‚¹ã®å¯èª­æ€§ã‚’å‘ä¸Šã•ã›ã¦ãã ã•ã„`',
            '- `[REFACTOR] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–ã—ã¦ãã ã•ã„`',
            '- `[REFACTOR] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„`',
            '- `@claude-refactor ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„`',
            '',
            '### ğŸ’¡ åˆ©ç”¨å¯èƒ½ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ç¨®åˆ¥',
            '- ğŸ”„ é‡è¤‡ã‚³ãƒ¼ãƒ‰å‰Šé™¤ (DRYåŸå‰‡)',
            '- ğŸ“¦ ãƒ¡ã‚½ãƒƒãƒ‰æŠ½å‡º (å˜ä¸€è²¬ä»»åŸå‰‡)',
            '- ğŸ“ å¤‰æ•°åæ”¹å–„ (å‘½åè¦å‰‡)',
            '- ğŸ“š ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¿½åŠ  (JSDoc)',
            '- ğŸ›¡ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–',
            '- âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–',
            '- ğŸ“– å¯èª­æ€§å‘ä¸Š',
            '',
            '---',
            '*ğŸ”§ Claude Refactoring ã«ã‚ˆã‚Šè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ*'
          ].join('\n');

          await github.rest.issues.createComment({
            issue_number: issueNumber,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

    - name: Add refactoring labels
      uses: actions/github-script@v7
      with:
        script: |
          const preTests = '${{ steps.pre_tests.outputs.pre_tests_status }}';
          const postTests = '${{ steps.post_tests.outputs.post_tests_status }}';
          const refactorType = '${{ steps.analyze.outputs.refactor_type }}';
          
          let labels = ['refactored', refactorType];
          
          if (preTests === 'passed' && postTests === 'passed') {
            labels.push('refactor-success');
          } else if (postTests === 'failed') {
            labels.push('refactor-needs-fix');
          } else {
            labels.push('refactor-review-needed');
          }
          
          await github.rest.issues.addLabels({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            labels: labels
          });