name: Claude Code Actions - PAT Version

on:
  issue_comment:
    types: [created]
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  claude-code:
    name: "🤖 Claude Code Actions (PAT)"
    runs-on: ubuntu-latest
    if: |
      contains(github.event.comment.body, '@claude') ||
      contains(github.event.issue.title, '[CLAUDE]') ||
      contains(github.event.pull_request.title, '[CLAUDE]') ||
      github.event.issue.user.login == github.repository_owner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        # Personal Access Token を使用
        token: ${{ secrets.CLAUDE_PAT }}

    - name: Run Claude Code Action
      uses: anthropics/claude-code-action@beta
      with:
        # Max plan で Claude Opus 4 と Sonnet 4 の自動切り替え
        model: "claude-opus-4-20250514"
        fallback_model: "claude-sonnet-4-20250514"
        anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
        
        # Personal Access Token を使用
        github_token: ${{ secrets.CLAUDE_PAT }}
        
        # トリガー設定
        trigger_phrase: "@claude"
        
        # タイムアウト設定（Max plan なので長時間処理可能）
        timeout_minutes: "60"
        
        # プロジェクト固有の指示
        custom_instructions: |
          You are working on a Node.js TDD project with:
          - ES6 modules
          - Jest testing framework  
          - ESLint for code quality
          - 100% test coverage requirement
          - Existing classes: Calculator, StringUtils
          
          Always:
          1. Generate appropriate tests for any code you create
          2. Follow existing code patterns and style
          3. Ensure all tests pass
          4. Provide clear explanations of changes
          5. Use natural language understanding (no keyword restrictions)
          
          Project structure:
          - src/ - implementation code
          - tests/ - test files
          - Use ESM imports/exports
          
        # 環境変数
        claude_env: |
          NODE_ENV=test